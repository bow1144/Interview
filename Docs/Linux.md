### Linux内存管理

<img width="513" alt="{CB0C5569-DD62-403D-A800-D7EB0CA5513E}" src="https://github.com/user-attachments/assets/df46134b-4fde-4276-bee1-9bb4c232c1ce">

1. **程序文件段**：只读，包含程序的二进制可执行代码
2. **已初始化数据段**：已初始化的全局变量和静态变量
3. **未初始化数据段**：未初始化的全局变量和静态变量
4. **堆段**：包括动态分配的内存，从低地址向上增长
5. **文件映射段**：动态库、共享内存等，从低地址向上
6. **栈段**：函数的参数和局部变量、上下文等，从高向低增长

### Linux虚拟内存
* 32位处理器的虚拟内存大小为4G，每个进程都认为自己有4G空间，但实际上只用到一点点虚拟内存
* 进程认为虚拟内存是连续的，实际上是多个内存碎片，还有一部分在磁盘上
* 应用程序从编写到执行需要**两次内存映射**：一次映射到虚拟内存，一次从虚拟内存映射到物理内存
* 第二次映射由软件和硬件共同完成，硬件是存储管理单元MMU，软件是OS的内存管理模块

## 一、常用操作
### 1.1 快捷键
* Tab：命令补全
* Ctrl+C：中断程序
* Ctrl+D：结束键盘输入

### 1.2 求助
* `--help`
* `man`

### 1.3 关机
* who：关机之前查看还有没有其它用户在线
* sync：将内存同步到硬盘
* shutdown：关机

### 1.4 PATH
环境变量：在用户输入命令时，在哪些目录中找到可执行文件

### 1.5 sudo
允许用户执行root命令，只有在`/etc/sudoers`中有的用户才能使用

### 1.6 包管理工具
RPM、DPKG

### 1.7 VIM三个模式
![vim模式](https://camo.githubusercontent.com/07692bd6dd6d0b166c2ae41761e52e7cc87cc2d7547f1c46eb0f497b4da48039/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f696d6167652d32303139313230393030323831383632362e706e67)

|命令|作用|
|---|---|
|:w|写入磁盘|
|:w!|强制写入磁盘|
|:q|离开|
|:q!|强制离开不保存|
|:wq|写入磁盘后离开|
|:wq!|强制写入磁盘并离开|

## 二、磁盘

### 2.1 磁盘接口
* IDE、SATA、SCSI、SAS

### 2.2 磁盘的文件名
* Linux中每个硬件都杯当成一个文件
  - IDE磁盘：`/dev/hd[a-d]`
  - SATA/SCSI/SAS：`/dev/sd[a-p]`
 
## 三、磁盘分区

### 3.1 MBR
* 第一个扇区有开机记录和分区表
* 分区表中最多存储四个分区
* Linux也把分区当成文件，命名方式为磁盘文件名：编号

### 3.2 GPT
* 第一个扇区记录主要开机记录
* 后面的33个分区记录分区信息
* 最后33个分区备份分区信息

### 3.3 开机检测程序BIOS
* Basic input/output System，是一个固件（嵌入硬件中的软件），在断定后内容放在不丢失的ROM中
* 是开机时计算机执行的第一个程序，读取磁盘第一个扇区的主要开机记录（MBR），MBR执行其中的开机管理程序，加载操作系统中的核心文件
* Bootloader负责引导操作系统
  - 提供启动菜单
  - 加载Linux内核和RAM
  - 将控制权交给Linux内核
 
## 四、文件系统

### 4.1 分区与文件系统
一个分区只能格式化为一个文件系统，但磁盘阵列技术可以将一个分区格式化为多个文件系统

### 4.2 组成
主要包括：
* incode：一个文件占用一个incode记录文件属性
* block：记录文件内容，一个文件过大时会占用多个block

### 4.3 文件读取
* 对于Ext2：incode查找文件内容所在block，把所有block内容读出来
* 对于FAT：没有incode，每个block存储下一个block的编号

### 4.4 磁盘碎片
block过去分散，磁头移动距离过大，降低磁盘读写性能

### 4.5 block
一个block只能被一个文件使用，未使用的部分直接浪费了，存储小文件应该用比较小的Block

|block大小|1kB|2kB|4kB|
|---|---|---|---|
|最大单一文件|16G|256G|2T|
|最大文件系统|2T|8T|16T|

### 4.6 incode
* incode中有以下信息：权限、拥有者、容量、建立修改读取时间等
* 每个incode大小固定为128byte、每个文件只占用一个incode
* 大文件通过间接引用incode，从而引用大量block

### 4.7 目录
* 一个目录分配一个incode和block，block记录目录下所有文件的incode和文件名
* 文件名记录在目录中，因此新增、删除文件操作与目录的权限有关

### 4.8 日志
突然断电会导致文件系统发生错误，block没有更新；可以通过日志修复文件系统

### 4.9 挂载
用目录作为文件系统的入口，也就是说进入目录后可以读取文件的数据

### 4.10 目录配置
基础三个目录如下：
* `/`root根目录
* `/usr`系统软件默认安装到这里
* `/var`存放系统或程序运行过程的数据

## 五、文件

### 5.1 文件属性
* 用户分为文件拥有者、群组和其它人，有不同的权限
* 常见的文件类型：`d:`目录、`-`文件、`l`链接文件
* 权限有三种：`r`,`w`,`x`可读、可写、可执行

### 5.2 文件与目录的基本操作
* `ls`列出文件和目录的信息，目录的信息就是其中的文件
* `cd`更换目录
* `mkdir`创建目录
* `rmdir`删除目录（必须为空）
* `touch`更新文件时间或建立新文件
* `cp`复制源文件
* `rm`删除文件
* `mv`移动文件

### 5.3 修改权限
* `## chmod [-R] xyz dirname/filename`
* 权限十位：例如`-rwxr-xr--`
  - 第一个-代表该文件是普通文件
  - 后三位`rwx`代表用户权限：读写执
  - `r-x`代表组权限：不可写
  - `r--`代表只可读
  - 后九位可以用`754`代替：`r=4, w=2, x=1`
* 为 `.bashrc` 文件的所有用户添加写权限:`## chmod a+w .bashrc`

### 5.4 默认权限
* 文件默认权限：默认不可执行：`666`
* 目录默认权限：目录必须可进入（执行）`777`

### 5.5 目录的权限
* 文件名存储在目录中，因此有文件的w权限不能修改文件名
* 目录的r权限表示可以读取文件列表、w表示可以修改文件列表、x是r和w的基础，让目录成为工作目录

### 5.6 链接
![链接](https://camo.githubusercontent.com/ece21395139b4bae26aec20b4107996abf268895bf026932b7ee353ccd3e1bda/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f31653436666430332d306364612d346436302d396231632d3063323536656461663662322e706e67)

* 实体链接：目录下的一个条目，记录文件名与源文件incode编号；删除条目后文件还存在
* 符号链接：符号链接文件中有源文件的绝对路径，可以理解为win的快捷方式

### 5.7 获取文件内容
1. `cat`取得文件内容
2. `tac`反向打印文件内容
3. `more`可以一页一页查看文件，适合大文件查看
4. `less`与more类似，但可以向前翻页
5. `head`取得文件前几行
6. `tail`后几行
7. `od`以16禁止的形式显示二进制文件

### 5.8 指令与文件搜索
1. `which` 指令搜索
2. `whereis`文件搜索
3. `locate`关键字/正则搜索
4. `find`通过文件属性和权限搜索


## 六、压缩与打包

### 6.1 压缩文件名
以`.zip`等结尾的是压缩，`.tar`结尾的是打包

### 6.2 压缩指令
1. gzip：最广泛使用的，压缩后源文件就不存在了
2. bzip2：更高的压缩比
3. xz：更更优的压缩比，但压缩比越高，压缩时间越长

### 6.3 打包
压缩只能压缩一个文件，打包可以将多个文件打包成一个大文件

## 七、Bash
> 命令解释器和脚本编辑器

### 7.1 特性
* 命令历史
* 命令和文件补全
* 命令别名
* 通配符

### 7.2 变量操作
```
$ x=abc      // 变量赋值
$ echo $x    // 取用变量要加$
$ echo ${x}  // 输出变量
```
* 双引号内的特殊字符可以保留原本特性，单引号内只能是字符串
* Bash变量可以是数组和整数，没有浮点数，默认为字符换

### 7.3 指令搜索顺序
* 绝对/相对路径
* 别名
* Bash内置指令
* %PATH变量的搜索路径的第一个指令

### 7.4 数据流重定向
* 重定向指的是用文件代替标准输入输出
* `>`表示覆盖重定向，`>>`表示追加重定向
* 可以将不需要的标准输出以及标准错误输出重定向到 /dev/null，相当于扔进垃圾箱。

## 八、管道命令
### 8.1 管道
* **管道是将一个命令的标准输出作为另一个文件的标准输入**
* 在命令之间用`|`分割多个管道命令

### 8.2 提取指令
* `cut`对数据进行切分，提取想要的部分

### 8.3 排序指令
* `sort`用于排序
* `uniq`可以对数据去重

### 8.4 双向输出重定向tee
* 不仅可以重定向到文件，还可以输出到屏幕上

### 8.5 字符转换指令
* `tr`删除或替换一行字符，`$ last | tr '[a-z]' '[A-Z]'`将拉斯特输出的信息小写转大写
* `col`将tab转化为字符空格
* `expand`将tab转化为一定数量的空格
* `join`聚合数据
* `paste`直接将两行粘在一起

### 8.6 分区指令
`split`将一个文件分割成多个文件

## 九、正则表达式
### 9.1 grep
* `$ grep -n 'the' regular_express.txt`表示在`regular_express.txt`中找the
* `$ grep -n 'a\{2,5\}' regular_express.txt`匹配a`m~n`次

### 9.2 printf
* 格式化输出`$ printf '%10s %5i %5i %5i %8.2f \n' $(cat printf.txt)`

### 9.3 awk
* 以行为单位处理文本`echo "data" | awk '{ print $1 }'`

## 十、进程管理

### 10.1 查看进程
* `ps`查看进程信息；`ps -l`查看自己的进程；`ps aux`查看系统所有进程
* `pstree`查看进程树
* `top`实时显示进程信息，两秒刷新一次
* `netstat`查看占用端口的进程

### 10.2 进程状态
状态|说明
---|---
R|执行或执行队列
D|不可中断阻塞（IO）
S|可中断阻塞
Z|僵死，进程已终止但其父不知道
T|结束

### 10.3 SIGCHID
* 子进程改变状态时，父进程收到SIGCHID
* 其中包含子进程信息（PID等）
* 子进程退出时，进程描述符不会立即释放，为了让父进程通过`wait()`等获得子进程信息

### 10.4 wait() 
* 直到收到子进程退出的SIGCHID信号，父进程的wait()会一直阻塞
* 成功后收集PID
* `status`保存子进程退出的状态
* `waitpid`和wait几乎相同

### 10.5 孤儿进程
* 父进程退出，他的子进程成为孤儿进程
* 这些孤儿进程被`inti`进程收养和状态收集，故不会对系统造成伤害

### 10.6 僵尸进程
* 子进程退出但父进程没有`wait()`，PID仍保存在系统中，这称之为僵尸进程
* 系统的进程号有限，大量僵尸进程会占用进程号
* 只要消灭父进程，僵尸进程变孤儿，被init收养，结束僵尸进程
